<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CI360 - Projeto de Teste</title>

  <!-- 1) Inicializa o stub do ci360 e define o tenantId -->
  <script>
    (function(ci, a) {
      window[ci] || (function() {
        var ef = window[ci] = function() { return ef.q.push(arguments); };
        ef.q = [];
        ef.a = a || {};
      })();
    })('ci360', {
      tenantId: '6b615c4d3c00016d3d12ce8f'
    });
  </script>

  <!-- 2) Carrega o SDK (use o MESMO src que aparece em SAS Tag Instructions) -->
  <script async
    data-efname="ci360"
    src="https://i-us.ci360.marketing/js/ot2.min.js"
    id="ob-script-async">
  </script>

  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 32px; line-height: 1.4; }
    .card { max-width: 880px; border: 1px solid #ddd; border-radius: 12px; padding: 18px 18px 8px; }
    h1 { margin: 0 0 8px; font-size: 24px; }
    p { margin: 10px 0; }
    button { padding: 10px 14px; font-size: 15px; border-radius: 10px; border: 1px solid #333; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
    code { background: #f6f6f6; padding: 2px 6px; border-radius: 6px; }
    .muted { color: #666; font-size: 13px; }
    .ok { color: #0b8f2f; font-weight: 700; }
    .bad { color: #b00020; font-weight: 700; }
    .log { background: #0b1020; color: #d6e1ff; padding: 12px; border-radius: 12px; min-height: 120px; white-space: pre-wrap; }
    .row { display: flex; gap: 14px; flex-wrap: wrap; align-items: center; }
  </style>
</head>

<body>
  <div class="card">
    <h1>CI360 – Projeto simples de teste</h1>

    <p>
      Use esta página para validar rapidamente a <b>Tag/SDK Web do CI360</b>.
      Abra no navegador e clique nos botões.
    </p>

    <p>
      <b>Evento principal (API event key no CI360):</b>
      <code id="eventNameUi"></code><br/>
      (Esse nome precisa ser <b>idêntico</b> ao <code>API event key</code> do seu Custom Event no CI360.)
    </p>

    <div class="row">
      <button onclick="enviarEventoBasico()">Enviar evento básico</button>
      <button onclick="enviarEventoComAtributo()">Enviar evento + atributo</button>
      <button onclick="testarCarregamento()">Testar se SDK carregou</button>
      <span id="status" class="bad">Status: aguardando SDK...</span>
    </div>

    <p class="muted">
      Dica: para validar o envio, abra o DevTools (F12) → aba <b>Network</b> e filtre por
      <code>ci360</code> ou <code>marketing</code>. Você deve ver chamada para
      <code>https://i-us.ci360.marketing/t/s/...</code> (geralmente status 204/200).
    </p>

    <p><b>Log:</b></p>
    <div id="log" class="log"></div>
  </div>

  <script>
    // ✅ IMPORTANTE: tem que bater com o "API event key" do CI360
    const EVENT_NAME = "teste_sdk_ci360";

    document.getElementById("eventNameUi").textContent = EVENT_NAME;

    const STATUS_EL = () => document.getElementById("status");

    function log(msg) {
      const el = document.getElementById("log");
      const now = new Date().toLocaleString();
      el.textContent = `[${now}] ${msg}\n` + el.textContent;
    }

    // Verifica se o SDK está disponível
    function sdkDisponivel() {
      return typeof window.ci360 === "function";
    }

    // Espera o SDK carregar (com timeout)
    function aguardarSdk(timeoutMs = 12000) {
      const started = Date.now();
      return new Promise((resolve, reject) => {
        const t = setInterval(() => {
          if (sdkDisponivel()) {
            clearInterval(t);
            resolve(true);
          } else if (Date.now() - started > timeoutMs) {
            clearInterval(t);
            reject(new Error("timeout"));
          }
        }, 200);
      });
    }

    async function testarCarregamento() {
      try {
        await aguardarSdk();
        STATUS_EL().className = "ok";
        STATUS_EL().textContent = "Status: SDK carregado ✅ (pronto para enviar eventos)";
        log("CI360 disponível: window.ci360 pronto.");
        alert("SDK carregado. Agora envie um evento e confira o Network.");
      } catch {
        STATUS_EL().className = "bad";
        STATUS_EL().textContent = "Status: SDK NÃO carregou ❌";
        log("CI360 não carregou dentro do tempo. Confira tenantId e src do ot2.min.js.");
        alert("SDK não carregou. Veja o log.");
      }
    }

    // ✅ Envio de Custom Event usando a Web Tag API (ot2)
    function enviarEventoBasico() {
      if (!sdkDisponivel()) {
        log("Não foi possível enviar: CI360 ainda não carregou.");
        alert("CI360 ainda não carregou. Clique em 'Testar se SDK carregou'.");
        return;
      }

      // Evento custom simples
      window.ci360("event", {
        name: EVENT_NAME
      });

      log(`Evento enviado: ${EVENT_NAME}`);
      alert("Evento disparado. Confira o Network por i-us.ci360.marketing/t/s/...");
    }

    function enviarEventoComAtributo() {
      if (!sdkDisponivel()) {
        log("Não foi possível enviar: CI360 ainda não carregou.");
        alert("CI360 ainda não carregou. Clique em 'Testar se SDK carregou'.");
        return;
      }

      window.ci360("event", {
        name: EVENT_NAME,
        attributes: {
          customName: "teste_botao",
          customGroupName: "grupo_teste"
        }
      });

      log(`Evento enviado c/ atributos: ${EVENT_NAME} (customName=teste_botao)`);
      alert("Evento + atributos disparado. Confira o Network.");
    }

    // Auto-check ao carregar
    (async () => {
      log("Página carregada. Aguardando CI360 (ot2.min.js) inicializar...");
      try {
        await aguardarSdk(8000);
        STATUS_EL().className = "ok";
        STATUS_EL().textContent = "Status: SDK carregado ✅ (pronto para enviar eventos)";
        log("CI360 disponível automaticamente: window.ci360 pronto.");
      } catch {
        STATUS_EL().className = "bad";
        STATUS_EL().textContent = "Status: aguardando SDK...";
        log("Ainda não detectei o SDK. Se demorar, clique em 'Testar se SDK carregou'.");
      }
    })();
  </script>
</body>
</html>
