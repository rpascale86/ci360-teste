<!doctype html>
<html lang="pt-pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CI360 ‚Äî Teste Web (Identity + login_id)</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f7fb; margin:0; padding:32px; }
    .card { background:#fff; border-radius:14px; box-shadow:0 8px 28px rgba(0,0,0,.08); max-width:860px; padding:24px; }
    h1 { margin:0 0 8px; font-size:22px; }
    .muted { color:#566; font-size:13px; margin:0 0 16px; line-height:1.35; }
    label { display:block; font-weight:600; margin:14px 0 6px; }
    input { width:100%; padding:12px; border-radius:10px; border:1px solid #ccd; font-size:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    button { padding:11px 14px; border-radius:10px; border:1px solid #223; background:#fff; cursor:pointer; font-size:14px; }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    button.good { border-color:#0a7a2a; color:#0a7a2a; }
    button.danger { border-color:#b91c1c; color:#b91c1c; }
    .status { margin-top:12px; font-weight:700; }
    .ok { color:#0a7a2a; }
    .warn { color:#b45309; }
    pre {
      margin-top:16px; background:#0b1530; color:#dbe7ff;
      padding:14px; border-radius:12px; height:300px; overflow:auto;
      font-size:12px; white-space:pre-wrap;
    }
    code { background:#f1f5f9; padding:2px 6px; border-radius:6px; color: #333; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 720px) { .grid { grid-template-columns:1fr; } }
  </style>

  <link rel="preload" href="https://i-us.ci360.marketing/js/ot2.min.js" as="script" />

  <!-- Vari√°vel Identity -->
  <script>
    (function initIdentityVar(){
      window.ci360_identity = localStorage.getItem("ci360_identity") || "";
    })();
  </script>

  <!-- Stub OT2 + tenant -->
  <script>
    (function(ci, a) {
      window[ci] || (function() {
        var ef = window[ci] = function() { return ef.q.push(arguments); };
        ef.q = [];
        ef.a = a || {};
      })();
    })(
      "ci360",
      { tenantId: "6b615c4d3c00016d3d12ce8f" }
    );
  </script>

  <!-- OT2 -->
  <script async data-efname="ci360" src="https://i-us.ci360.marketing/js/ot2.min.js" id="ob-script-async"></script>
</head>

<body>
  <div class="card">
    <h1>CI360 ‚Äî Teste Web Atualizado (Identity prim√°ria + login_id)</h1>

    <p class="muted">
      Fluxo: <b>1)</b> Set Identity ‚Üí <b>2)</b> Enviar Evento ‚Üí <b>3)</b> Limpar<br/>
      Evento (API key): <code id="eventKeyLabel"></code><br/>
      Identity: <code>customer_id</code> + <code>login_id</code> (email)
    </p>

    <div class="grid">
      <div>
        <label for="identityInput">customer_id (Identity prim√°ria)</label>
        <input id="identityInput" type="text" autocomplete="username" placeholder="ex: poc_web_001" />
      </div>
      <div>
        <label for="emailInput">email (Identity secund√°ria = login_id)</label>
        <input id="emailInput" type="email" inputmode="email" autocomplete="email" placeholder="ex: renanpascale+ci360poc001@gmail.com" />
      </div>
    </div>

    <div class="row">
      <button class="primary" id="btnSetIdentity">1) Set Identity</button>
      <button class="good" id="btnSendEvent" data-custom-event="web_poc_fire">2) Enviar Evento (<span id="eventKeyInline"></span>)</button>
      <button class="danger" id="btnClear">Limpar</button>
      <button id="btnTrace" style="border-color:#6366f1; color:#6366f1;">üîç Trace / Debug SDK</button>
    </div>

    <div class="status" id="sdkStatus" aria-live="polite"></div>
    <pre id="log" aria-live="polite"></pre>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const TENANT_ID = "6b615c4d3c00016d3d12ce8f";
    const EVENT_API_KEY = "web_poc_fire";

    const IDENTIFY_LOGIN_FIELD = "login_id";

    const ATTR_CUSTOMER_ID     = "customer_id";
    const ATTR_EMAIL_INPUT     = "email_input";
    const ATTR_EMAIL_ADDRESS   = "email_address";
    const ATTR_EMAIL_PERMISSION= "email_permission";
    const ATTR_POC_SOURCE      = "poc_source";
    const ATTR_TS              = "ts";

    const EMAIL_PERMISSION_VALUE = "Y";
    const POC_SOURCE_VALUE = "web";

    // =========================
    // UI helpers
    // =========================
    const $ = (id) => document.getElementById(id);
    const logEl = $("log");
    const sdkStatus = $("sdkStatus");

    $("eventKeyLabel").textContent = EVENT_API_KEY;
    $("eventKeyInline").textContent = EVENT_API_KEY;

    function log(msg, data = null){
      const ts = new Date().toLocaleString();
      let extra = data ? "\n" + JSON.stringify(data, null, 2) : "";
      logEl.textContent = `[${ts}] ${msg}${extra}\n` + logEl.textContent;
      try { 
        if(data) {
          console.trace("[CI360-PoC Trace]", msg, data); 
        } else {
          console.log("[CI360-PoC]", msg);
        }
      } catch {}
    }
    
    function setStatus(text, cls){
      sdkStatus.className = "status " + (cls || "");
      sdkStatus.textContent = text;
    }
    function isEmail(val) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
    }

    function runtimeDisponivel() {
      return (typeof window.ci360 === "function" && !window.ci360.q);
    }
    function aguardarRuntime(timeoutMs = 12000) {
      const start = Date.now();
      return new Promise((resolve, reject) => {
        const int = setInterval(() => {
          if (runtimeDisponivel()) { clearInterval(int); resolve(true); }
          else if (Date.now() - start > timeoutMs) { clearInterval(int); reject(new Error("timeout")); }
        }, 200);
      });
    }

    function buildIdentifyPayload(customerId, email) {
      const payload = { customer_id: customerId };
      if (email) {
        payload[IDENTIFY_LOGIN_FIELD] = email;
      }
      return payload;
    }

    // =========================
    // INIT
    // =========================
    (function init(){
      const idVal = localStorage.getItem("ci360_identity") || "";
      const emailVal = localStorage.getItem("ci360_email") || "";

      if (idVal) $("identityInput").value = idVal;
      if (emailVal) $("emailInput").value = emailVal;

      log(idVal ? `Identity atual (customer_id): ${idVal}` : "Identity atual: (nenhuma)");
      if (emailVal) log(`Email atual (login_id): ${emailVal}`);

      setStatus("A a aguardar runtime do CI360...", "warn");

      aguardarRuntime(12000)
        .then(() => {
          setStatus("SDK detetado ‚úÖ (runtime ativo)", "ok");
          log("Runtime do CI360 ativo.");
          log(`Tenant confirmado: ${TENANT_ID}`);
          log(`Evento configurado (API key): ${EVENT_API_KEY}`);
        })
        .catch(() => {
          setStatus("Runtime n√£o carregou ‚ùå", "warn");
          log("Runtime n√£o foi detetado no tempo. Verifique tenantId/consent/adblock/rede.");
        });
    })();

    // =========================
    // 1) Set Identity
    // =========================
    $("btnSetIdentity").addEventListener("click", async () => {
      const customerId = $("identityInput").value.trim();
      const email = $("emailInput").value.trim();

      if (!customerId) { alert("Introduza um customer_id."); return; }
      if (email && !isEmail(email)) { alert("Email inv√°lido."); return; }

      localStorage.setItem("ci360_identity", customerId);
      window.ci360_identity = customerId;

      if (email) localStorage.setItem("ci360_email", email);
      else localStorage.removeItem("ci360_email");

      log(`Guardado: customer_id=${customerId} | email=${email || "(vazio)"}`);

      try {
        await aguardarRuntime(10000);
        const identifyPayload = buildIdentifyPayload(customerId, email);

        window.ci360("identify", identifyPayload);

        log(`identify enviado ‚úÖ: ${JSON.stringify(identifyPayload)}`);
        setStatus("identify enviado ‚úÖ", "ok");
      } catch (e) {
        setStatus("Runtime n√£o dispon√≠vel ‚ùå", "warn");
        log("Falha ao enviar identify: runtime n√£o dispon√≠vel.");
      }
    });

    // =========================
    // SINCRONIZAR ATRIBUTOS HTML (M√âTODO DECLARATIVO)
    // =========================
    function syncDataAttributes() {
      const btn = $("btnSendEvent");
      const customerId = $("identityInput").value.trim();
      const email = $("emailInput").value.trim();

      // O SDK do CI360 captura eventos nativamente se o bot√£o tiver 'data-custom-event'
      btn.setAttribute("data-custom-attribute-customer_id", customerId);
      btn.setAttribute("data-custom-attribute-email_input", email);
      btn.setAttribute("data-custom-attribute-email_address", email);
      btn.setAttribute("data-custom-attribute-email_permission", EMAIL_PERMISSION_VALUE);
      btn.setAttribute("data-custom-attribute-poc_source", POC_SOURCE_VALUE);
      // O atributo 'ts' foi removido para evitar falhas de tipagem estrita no SDK.
    }

    $("identityInput").addEventListener("input", syncDataAttributes);
    $("emailInput").addEventListener("input", syncDataAttributes);

    // =========================
    // 2) Enviar Custom Event (JS API + HTML Native Fallback)
    // =========================
    $("btnSendEvent").addEventListener("click", async () => {
      syncDataAttributes(); // Garante que os dados est√£o atualizados no HTML

      const customerId = $("identityInput").value.trim();
      const email = $("emailInput").value.trim();

      if (!customerId) { alert("Preencha o customer_id."); return; }
      if (!email) { alert("Preencha o email."); return; }
      if (!isEmail(email)) { alert("Email inv√°lido."); return; }

      try {
        await aguardarRuntime(10000);

        // Omitimos o atributo 'ts' (timestamp) do payload.
        // O CI360 recolhe o timestamp automaticamente. Enviar uma string
        // num campo que possa estar configurado como num√©rico rejeita o evento.
        const eventPayload = {
          eventName: EVENT_API_KEY, 
          attributes: {
            [ATTR_CUSTOMER_ID]: String(customerId),
            [ATTR_EMAIL_INPUT]: String(email),
            [ATTR_EMAIL_ADDRESS]: String(email),
            [ATTR_EMAIL_PERMISSION]: String(EMAIL_PERMISSION_VALUE),
            [ATTR_POC_SOURCE]: String(POC_SOURCE_VALUE)
          }
        };

        window.ci360("customEvent", eventPayload);

        log(`customEvent disparado ‚úÖ\n(O bot√£o possui 'data-custom-event' para captura nativa)\nPayload: ${JSON.stringify(eventPayload)}`);
        alert(`Evento enviado (${EVENT_API_KEY}). Verifique a extens√£o SAS Tag e o CI360.`);

      } catch (e) {
        setStatus("Runtime n√£o dispon√≠vel ‚ùå", "warn");
        log("Falha ao disparar evento: runtime n√£o dispon√≠vel.");
        alert("Runtime n√£o carregou. Verifique tenantId/bloqueios.");
      }
    });

    // =========================
    // 3) Limpar
    // =========================
    $("btnClear").addEventListener("click", () => {
      localStorage.removeItem("ci360_identity");
      localStorage.removeItem("ci360_email");

      window.ci360_identity = "";
      $("identityInput").value = "";
      $("emailInput").value = "";

      log("Dados limpos. Recarregue a p√°gina (Ctrl+F5) para um teste limpo.");
      setStatus("Dados limpos ‚úÖ", "ok");
      alert("Dados limpos. Fa√ßa Ctrl+F5 para um teste limpo.");
    });

    // =========================
    // 4) Trace / Debug SDK
    // =========================
    $("btnTrace").addEventListener("click", () => {
      log("--- INICIANDO TRACE / DEBUG INFO ---");
      
      const traceData = {
        url: window.location.href,
        userAgent: navigator.userAgent,
        localStorage: {
          ci360_identity: localStorage.getItem("ci360_identity"),
          ci360_email: localStorage.getItem("ci360_email")
        },
        windowVars: {
          ci360_identity: window.ci360_identity
        },
        sdkState: {
          runtimeDisponivel: runtimeDisponivel(),
          queueLength: window.ci360 && window.ci360.q ? window.ci360.q.length : 0,
          isBlockedByAdblocker: !document.getElementById("ob-script-async"),
          cookiesSAS: document.cookie.includes("ci360") || document.cookie.includes("sas") ? "Presentes" : "Ausentes/Bloqueados"
        }
      };
      
      log("Estado atual do Sistema e SDK:", traceData);
      
      // For√ßa um aviso se existirem eventos presos na fila (queue)
      if (traceData.sdkState.queueLength > 0) {
        log(`‚ö†Ô∏è ATEN√á√ÉO: Existem ${traceData.sdkState.queueLength} eventos pendentes na fila do SDK. O SAS CI360 n√£o os enviou para a rede. Verifique bloqueadores de an√∫ncios ou erros de consentimento.`);
      } else if (!traceData.sdkState.runtimeDisponivel) {
        log("‚ùå ERRO CR√çTICO: O motor do SAS CI360 (Runtime) n√£o est√° a funcionar. Os eventos n√£o v√£o ser enviados.");
      } else {
        log("‚úÖ SDK parece estar saud√°vel e a fila de eventos est√° limpa (eventos foram processados).");
      }
    });
  </script>
</body>
</html>