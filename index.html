<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CI360 — Teste Web (Click + Identity + Email)</title>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f7fb; margin:0; padding:32px; }
    .card { background:#fff; border-radius:14px; box-shadow:0 8px 28px rgba(0,0,0,.08); max-width:860px; padding:24px; }
    h1 { margin:0 0 8px; font-size:22px; }
    .muted { color:#566; font-size:13px; margin:0 0 16px; line-height:1.35; }
    label { display:block; font-weight:600; margin:14px 0 6px; }
    input { width:100%; padding:12px; border-radius:10px; border:1px solid #ccd; font-size:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    button {
      padding:11px 14px; border-radius:10px; border:1px solid #223;
      background:#fff; cursor:pointer; font-size:14px;
    }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    button.danger { border-color:#b91c1c; color:#b91c1c; }
    button.good { border-color:#0a7a2a; color:#0a7a2a; }
    .status { margin-top:12px; font-weight:700; }
    .ok { color:#0a7a2a; }
    .warn { color:#b45309; }
    pre {
      margin-top:16px; background:#0b1530; color:#dbe7ff;
      padding:14px; border-radius:12px; height:280px; overflow:auto;
      font-size:12px; white-space:pre-wrap;
    }
    .pill { display:inline-block; background:#eef2ff; color:#1f2a63; padding:3px 8px; border-radius:999px; font-size:12px; }
    .help { margin-top:14px; font-size:13px; color:#334; line-height:1.35; }
    code { background:#f1f5f9; padding:2px 6px; border-radius:6px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 720px) { .grid { grid-template-columns:1fr; } }
    .kvs { margin-top:10px; font-size:12px; color:#223; }
    .kvs b { font-weight:700; }
  </style>

  <!--
    1) Identity JS variable (para "User Identification Definition" no CI360)
       - Precisa existir ANTES do SAS Tag carregar
       - No CI360 você aponta para JavaScript variable: ci360_identity
  -->
  <script>
    (function initIdentityVar(){
      const saved = localStorage.getItem("ci360_identity") || "";
      window.ci360_identity = saved;
    })();
  </script>

  <!--
    2) CI360 stub + tenant (MANTIDO NO FORMATO HOMOLOGADO)
    Observação: o stub sempre existe como function e mantém fila em ci360.q até o runtime assumir.
  -->
  <script>
    (function(ci, a) {
      window[ci] || (function() {
        var ef = window[ci] = function() { return ef.q.push(arguments); };
        ef.q = [];
        ef.a = a || {};
      })();
    })('ci360', {
      tenantId: '6b615c4d3c00016d3d12ce8f'
    });
  </script>

  <!-- 3) CI360 Web Tag (ot2) — MANTIDA (homologada) -->
  <script async data-efname="ci360" src="https://i-us.ci360.marketing/js/ot2.min.js" id="ob-script-async"></script>
</head>

<body>
  <div class="card">
    <h1>CI360 — Teste Web (Click + Identity + Email)</h1>

    <p class="muted">
      Click target ID: <span class="pill">btn-ci360-evento-basico</span><br/>
      Custom Event API key (JS API): <span class="pill" id="apiKeyPill"></span><br/>
      Identity var (User Identification): <code>window.ci360_identity</code> (customer_id)<br/>
      <b>Para Journey + Triggered Email:</b> use o botão <b>3) Disparar Custom Event (JS API)</b> (ele envia <code>email_address</code> junto).
    </p>

    <div class="grid">
      <div>
        <label>customer_id (Identity)</label>
        <input id="identityInput" placeholder="ex: teste_01" autocomplete="off" />
      </div>
      <div>
        <label>email_address (para Triggered Email)</label>
        <input id="emailInput" placeholder="ex: renan.pascale@gmwit.com.br" autocomplete="off" />
      </div>
    </div>

    <div class="row">
      <button class="primary" id="btnSetIdentity">1) Set Identity</button>

      <!-- Click Event -->
      <button id="btn-ci360-evento-basico">2) Disparar evento (Click)</button>

      <!-- Custom Event via JS API (recomendado para Email Journey) -->
      <button class="good" id="btnFireJsApiEvent">3) Disparar Custom Event (JS API)</button>

      <button class="danger" id="btnClearIdentity">Limpar identity</button>
      <button id="btnTestSdk">Testar SDK</button>
    </div>

    <div class="status" id="sdkStatus"></div>

    <div class="kvs" id="diag"></div>

    <div class="help">
      <b>Fluxo recomendado:</b><br/>
      1) Preencha <code>customer_id</code> e <code>email_address</code>.<br/>
      2) Clique em <b>1) Set Identity</b> (salva <code>ci360_identity</code> e envia <code>identify</code> com runtime ativo).<br/>
      3) Clique em <b>3) Disparar Custom Event (JS API)</b> (envia <code>email_address</code> + <code>customer_id</code> no evento).<br/><br/>

      <b>Validação no browser:</b> DevTools → Network → filtre por <code>/t/s/</code> → veja requests 200/204 e procure <code>email_address</code> no Payload.<br/>
      <b>Dica:</b> Se aparecer erro “Not able to perform event/identify”, é porque você chamou o stub (fila). Este index espera o runtime e ainda faz fallback para <code>c1360</code> se o tenant expor o runtime por esse nome.
    </div>

    <pre id="log"></pre>
  </div>

  <script>
    // >>> Ajuste se necessário (precisa bater com o trigger no CI360)
    const CUSTOM_EVENT_API_KEY = "teste_sdk_ci360";
    document.getElementById("apiKeyPill").textContent = CUSTOM_EVENT_API_KEY;

    // ========= helpers =========
    const $ = (id) => document.getElementById(id);
    const logEl = $("log");
    const sdkStatus = $("sdkStatus");
    const diagEl = $("diag");

    function log(msg){
      const ts = new Date().toLocaleString();
      logEl.textContent = `[${ts}] ${msg}\n` + logEl.textContent;
      try { console.log("[CI360-TEST]", msg); } catch {}
    }
    function setStatus(text, cls){
      sdkStatus.className = "status " + (cls || "");
      sdkStatus.textContent = text;
    }

    // Melhor prática: validação mínima de email (client-side só para evitar erro óbvio)
    function isEmailLike(v) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }

    // ===== Runtime detection (melhores práticas) =====
    // Motivo: o stub sempre existe e mantém fila em .q. Só consideramos "pronto" quando NÃO há .q.
    // Além disso, alguns tenants expõem o runtime como c1360. Mantemos a tag homologada e fazemos "bridge" só no JS.
    function getCiRuntime() {
      const ci = window.ci360;
      const c1 = window.c1360;

      // 1) ci360 runtime já assumiu (sem fila)
      if (typeof ci === "function" && !ci.q) return ci;

      // 2) runtime exposto como c1360 (sem fila) — cria alias para manter compatível com a sua base
      if (typeof c1 === "function" && !c1.q) {
        window.ci360 = c1; // bridge
        return c1;
      }

      return null; // ainda está no stub
    }

    function aguardarRuntime(timeoutMs = 12000) {
      const started = Date.now();
      return new Promise((resolve, reject) => {
        const t = setInterval(() => {
          const rt = getCiRuntime();
          if (rt) { clearInterval(t); resolve(rt); }
          else if (Date.now() - started > timeoutMs) { clearInterval(t); reject(new Error("timeout")); }
        }, 200);
      });
    }

    function renderDiag() {
      const hasCi = typeof window.ci360 === "function";
      const hasC1 = typeof window.c1360 === "function";
      const ciQ = hasCi ? !!window.ci360.q : false;
      const c1Q = hasC1 ? !!window.c1360.q : false;
      const rt = getCiRuntime();
      const rtName =
        rt === window.ci360 ? "ci360" :
        rt === window.c1360 ? "c1360" :
        rt ? "runtime" : "—";

      diagEl.innerHTML =
        `<b>Diagnóstico:</b> ` +
        `ci360=${hasCi ? "sim" : "não"} (q=${ciQ ? "sim" : "não"}), ` +
        `c1360=${hasC1 ? "sim" : "não"} (q=${c1Q ? "sim" : "não"}), ` +
        `runtime=${rt ? "ok" : "pendente"} (<b>${rtName}</b>)`;
    }

    // Preenche inputs com valores atuais
    (function(){
      const currentId = window.ci360_identity || "";
      $("identityInput").value = currentId;
      log(currentId ? `Identity atual (window.ci360_identity): ${currentId}` : "Identity atual: (nenhuma)");

      const savedEmail = localStorage.getItem("ci360_email") || "";
      if (savedEmail) $("emailInput").value = savedEmail;

      renderDiag();
    })();

    // Auto-check ao carregar
    (async () => {
      setStatus("Aguardando runtime do CI360...", "warn");
      try {
        await aguardarRuntime(12000);
        setStatus("SDK detectado ✅ (runtime ativo)", "ok");
        log("Runtime do CI360 ativo. Pode enviar identify/event com segurança.");
      } catch {
        setStatus("Runtime não ficou ativo ❌ (timeout). Confira tenantId/src/consent/adblock.", "warn");
        log("Runtime não ficou ativo no tempo. Pageview pode existir, mas JS API pode falhar se estiver no stub.");
      } finally {
        renderDiag();
      }
    })();

    // ========= botões =========

    // 1) Set Identity
    $("btnSetIdentity").addEventListener("click", async () => {
      const customerId = $("identityInput").value.trim();
      const email = $("emailInput").value.trim();

      if (!customerId) {
        alert("Informe um customer_id (ex.: teste_01).");
        return;
      }
      if (email && !isEmailLike(email)) {
        alert("Email parece inválido. Ex.: renan.pascale@gmwit.com.br");
        return;
      }

      // Persistência para User Identification Definition (Page View)
      localStorage.setItem("ci360_identity", customerId);
      window.ci360_identity = customerId;
      if (email) localStorage.setItem("ci360_email", email);

      log(`Identity salva: ${customerId} (localStorage + window.ci360_identity).`);
      renderDiag();

      try {
        const rt = await aguardarRuntime(12000);

        // Melhor prática: identify só com customer_id
        rt("identify", { customer_id: customerId });
        log(`identify enviado: { customer_id: '${customerId}' }`);

        setStatus("SDK detectado ✅ (runtime ativo)", "ok");
        renderDiag();

        alert("Identity setada. Agora use o botão 3 (JS API) para disparar evento com email_address e acionar o Triggered Email.");
      } catch {
        log("Falha: runtime não disponível para enviar identify (timeout).");
        setStatus("Aguardando runtime do CI360...", "warn");
        renderDiag();
        alert("Runtime do CI360 não disponível (timeout). Recarregue e verifique bloqueios (consent/adblock).");
      }
    });

    // Limpar identity
    $("btnClearIdentity").addEventListener("click", () => {
      localStorage.removeItem("ci360_identity");
      localStorage.removeItem("ci360_email");
      window.ci360_identity = "";
      $("identityInput").value = "";
      $("emailInput").value = "";
      log("Identity/email removidos (localStorage + window.ci360_identity).");
      renderDiag();
      alert("Identity/email removidos. Recarregue a página (F5).");
    });

    // 2) Click event (target id)
    $("btn-ci360-evento-basico").addEventListener("click", () => {
      log("Click no botão de evento (id=btn-ci360-evento-basico). Valide /t/s/ no Network (200/204).");
      renderDiag();
      alert("Evento de CLICK disparado. (Útil para validar Click Event no CI360; não leva email como atributo.)");
    });

    // 3) Custom Event via JS API (melhor para Journey + Triggered Email)
    $("btnFireJsApiEvent").addEventListener("click", async () => {
      const customerId = $("identityInput").value.trim();
      const email = $("emailInput").value.trim();

      if (!customerId) {
        alert("Preencha customer_id antes.");
        return;
      }
      if (!email) {
        alert("Preencha email_address (isso é o que o Triggered Email precisa).");
        return;
      }
      if (!isEmailLike(email)) {
        alert("Email parece inválido. Ex.: renan.pascale@gmwit.com.br");
        return;
      }

      // Persistência (mantém pageview/identity alinhados)
      localStorage.setItem("ci360_identity", customerId);
      window.ci360_identity = customerId;
      localStorage.setItem("ci360_email", email);

      renderDiag();

      try {
        const rt = await aguardarRuntime(12000);

        // (1) garante identificação
        rt("identify", { customer_id: customerId });

        // (2) dispara o Custom Event COM ATRIBUTOS (email_address)
        rt("event", CUSTOM_EVENT_API_KEY, {
          customer_id: customerId,
          email_address: email,
          source: "web_test"
        });

        log(`event enviado: key='${CUSTOM_EVENT_API_KEY}', { customer_id:'${customerId}', email_address:'${email}', source:'web_test' }`);
        renderDiag();
        alert("Custom Event (JS API) enviado com email_address. Agora o Journey/Triggered Email tem o atributo necessário.");
      } catch (e) {
        log("Falha ao enviar JS API event (runtime indisponível/timeout).");
        renderDiag();
        alert("Runtime do CI360 não disponível. Verifique se o OT2 carregou e se não há bloqueio (consent/adblock).");
      }
    });

    // Testar SDK manual (runtime)
    $("btnTestSdk").addEventListener("click", async () => {
      try {
        await aguardarRuntime(8000);
        setStatus("SDK detectado ✅ (runtime ativo)", "ok");
        renderDiag();
        log("Teste runtime: OK.");
        alert("Runtime do CI360 carregado.");
      } catch {
        setStatus("Runtime não carregou ❌", "warn");
        renderDiag();
        log("Teste runtime: falhou (timeout).");
        alert("Runtime não carregou. Verifique tenantId, URL do ot2, e bloqueios (consent/adblock).");
      }
    });

    // Atualiza diag periodicamente (útil em casos de carregamento lento)
    setInterval(renderDiag, 1500);
  </script>
</body>
</html>
