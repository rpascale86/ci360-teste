<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CI360 — Teste Web (Click + Identity + Email)</title>

  <!-- Estilos básicos para visualização da PoC -->
  <style>
    body { font-family: Arial, sans-serif; background:#f5f7fb; margin:0; padding:32px; }
    .card { background:#fff; border-radius:14px; box-shadow:0 8px 28px rgba(0,0,0,.08); max-width:820px; padding:24px; }
    h1 { margin:0 0 8px; font-size:22px; }
    .muted { color:#566; font-size:13px; margin:0 0 16px; line-height:1.35; }
    label { display:block; font-weight:600; margin:14px 0 6px; }
    input { width:100%; padding:12px; border-radius:10px; border:1px solid #ccd; font-size:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    button {
      padding:11px 14px; border-radius:10px; border:1px solid #223;
      background:#fff; cursor:pointer; font-size:14px;
    }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    button.danger { border-color:#b91c1c; color:#b91c1c; }
    button.good { border-color:#0a7a2a; color:#0a7a2a; }
    .status { margin-top:12px; font-weight:700; }
    .ok { color:#0a7a2a; }
    .warn { color:#b45309; }
    pre {
      margin-top:16px; background:#0b1530; color:#dbe7ff;
      padding:14px; border-radius:12px; height:260px; overflow:auto;
      font-size:12px; white-space:pre-wrap;
    }
    .pill { display:inline-block; background:#eef2ff; color:#1f2a63; padding:3px 8px; border-radius:999px; font-size:12px; }
    .help { margin-top:14px; font-size:13px; color:#334; line-height:1.35; }
    code { background:#f1f5f9; padding:2px 6px; border-radius:6px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 720px) { .grid { grid-template-columns:1fr; } }
  </style>

  <!-- 1) Variável de identidade para User Identification Definition no CI360
       Deve existir antes do carregamento da Tag OT2.
  -->
  <script>
    (function initIdentityVar(){
      const saved = localStorage.getItem("ci360_identity") || "";
      window.ci360_identity = saved;
    })();
  </script>

  <!-- 2) Stub da biblioteca OT2 + tenantId
       Este código permanece conforme homologado pelo CI360.
  -->
  <script>
    (function(ci, a) {
      window[ci] || (function() {
        var ef = window[ci] = function() { return ef.q.push(arguments); };
        ef.q = [];
        ef.a = a || {};
      })();
    })(
      'ci360',
      { tenantId: '6b615c4d3c00016d3d12ce8f' } // Substitua aqui pelo tenantId real, se necessário.
    );
  </script>

  <!-- 3) Inclusão da biblioteca OT2 (tag do CI360) -->
  <script async data-efname="ci360" src="https://i-us.ci360.marketing/js/ot2.min.js" id="ob-script-async"></script>

</head>
<body>
  <div class="card">
    <h1>CI360 — Teste Web (Click + Identity + Email)</h1>

    <p class="muted">
      Este exemplo demonstra como configurar a PoC de coleta de identidade, disparo de evento customizado e envio de e‑mail na SAS CI360.<br/>
      Variáveis que serão capturadas:<br/>
      <code>window.ci360_poc_customer_id</code>, <code>window.ci360_poc_email</code> e <code>window.ci360_poc_fire</code>.<br/>
      Gatilho do evento: mudança em <code>window.ci360_poc_fire</code> (qualquer valor).<br/>
      Atributos customizados: <b>customer_id</b> e <b>email_input</b>.
    </p>

    <div class="grid">
      <div>
        <label>customer_id (Identity)</label>
        <input id="identityInput" placeholder="ex: teste_01" />
      </div>
      <div>
        <label>email (para Journey/Triggered Email)</label>
        <input id="emailInput" placeholder="ex: usuario@empresa.com" />
      </div>
    </div>

    <div class="row">
      <button class="primary" id="btnSetIdentity">1) Set Identity</button>

      <!-- Click Event: capturado automaticamente pelo OT2 -->
      <button id="btn-ci360-evento-basico">2) Disparar evento (Click)</button>

      <!-- Jornada via mudança de variável JS -->
      <button class="good" id="btnFireJourney">3) Disparar Journey</button>

      <button class="danger" id="btnClearIdentity">Limpar</button>
      <button id="btnTestSdk">Testar runtime</button>
    </div>

    <div class="status" id="sdkStatus"></div>

    <div class="help">
      <b>Fluxo de teste:</b><br/>
      1) Preencha os campos <code>customer_id</code> e <code>email</code>.<br/>
      2) Clique em <b>1) Set Identity</b> para salvar a identidade e enviar o comando <code>identify</code>.<br/>
      3) Clique em <b>3) Disparar Journey</b>: serão definidas as variáveis globais e disparado o evento de mudança de variável.<br/>
      4) A journey configurada no CI360 deve acionar o envio de e‑mail.
    </div>

    <pre id="log"></pre>
  </div>

  <script>
    // Helpers para log e status
    const $ = (id) => document.getElementById(id);
    const logEl = $("log");
    const sdkStatus = $("sdkStatus");

    function log(msg){
      const ts = new Date().toLocaleString();
      logEl.textContent = `[${ts}] ${msg}\n` + logEl.textContent;
      try { console.log("[CI360-PoC]", msg); } catch {}
    }
    function setStatus(text, cls){
      sdkStatus.className = "status " + (cls || "");
      sdkStatus.textContent = text;
    }

    function isEmail(val) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val);
    }

    // Verifica se o runtime OT2 já substituiu o stub (ou seja, ci360.q indefinido)
    function runtimeDisponivel() {
      return (typeof window.ci360 === "function" && !window.ci360.q);
    }

    function aguardarRuntime(timeoutMs = 12000) {
      const start = Date.now();
      return new Promise((resolve, reject) => {
        const int = setInterval(() => {
          if (runtimeDisponivel()) { clearInterval(int); resolve(true); }
          else if (Date.now() - start > timeoutMs) { clearInterval(int); reject(new Error("timeout")); }
        }, 200);
      });
    }

    // Preencher inputs com valores salvos
    (function(){
      const idVal = window.ci360_identity || "";
      $("identityInput").value = idVal;
      log(idVal ? `Identity atual: ${idVal}` : "Identity atual: (nenhuma)");
      const emailVal = localStorage.getItem("ci360_email") || "";
      if (emailVal) $("emailInput").value = emailVal;
    })();

    // Checar runtime ao carregar
    (async () => {
      setStatus("Aguardando runtime do CI360...", "warn");
      try {
        await aguardarRuntime(12000);
        setStatus("SDK detectado ✅ (runtime ativo)", "ok");
        log("Runtime do CI360 ativo. Pronto para identificar e disparar eventos.");
      } catch {
        setStatus("Runtime não carregou ❌", "warn");
        log("Runtime não foi detectado no tempo. Verifique tenantId ou bloqueios.");
      }
    })();

    // 1) Set Identity
    $("btnSetIdentity").addEventListener("click", async () => {
      const customerId = $("identityInput").value.trim();
      const email     = $("emailInput").value.trim();

      if (!customerId) { alert("Informe um customer_id."); return; }
      if (email && !isEmail(email)) { alert("Email inválido."); return; }

      localStorage.setItem("ci360_identity", customerId);
      window.ci360_identity = customerId;
      if (email) localStorage.setItem("ci360_email", email);

      log(`Identity salva: ${customerId}`);

      try {
        await aguardarRuntime(10000);
        // Envia o identify para o runtime
        window.ci360("identify", { customer_id: customerId });
        log(`identify enviado: { customer_id: '${customerId}' }`);
        setStatus("SDK detectado ✅", "ok");
      } catch {
        setStatus("Aguardando runtime...", "warn");
        log("Falha ao enviar identify: runtime não disponível.");
      }
    });

    // Botão 2: click tracking
    $("btn-ci360-evento-basico").addEventListener("click", () => {
      log("Click registrado. O OT2 enviará automaticamente um evento /t/s/.");
      alert("Evento de CLICK disparado (tracking automático).");
    });

    // 3) Disparar Journey via JS Variable Change
    $("btnFireJourney").addEventListener("click", async () => {
      const customerId = $("identityInput").value.trim();
      const email      = $("emailInput").value.trim();

      if (!customerId) { alert("Preencha customer_id."); return; }
      if (!email) { alert("Preencha o email."); return; }
      if (!isEmail(email)) { alert("Email inválido."); return; }

      // Persistência das informações
      localStorage.setItem("ci360_identity", customerId);
      window.ci360_identity = customerId;
      localStorage.setItem("ci360_email", email);

      // Variáveis que o OT2 vai capturar como atributos
      window.ci360_poc_customer_id = customerId;
      window.ci360_poc_email       = email;

      try {
        await aguardarRuntime(10000);
        // Reforça a identificação, garantindo que o runtime conheça o customer_id atual
        window.ci360("identify", { customer_id: customerId });
      } catch {
        // se o runtime não estiver ativo, ainda assim criamos as variáveis — elas serão coletadas ao ativar
      }

      // Dispara a variável gatilho: isso acionará o evento Custom Event no CI360
      window.ci360_poc_fire = Date.now();

      log(`Journey trigger enviado: {fire: ${window.ci360_poc_fire}, customer_id: '${customerId}', email: '${email}'}`);
      alert("Gatilho de Journey enviado. Verifique a entrada na Journey e o envio de e‑mail.");
    });

    // Limpar dados
    $("btnClearIdentity").addEventListener("click", () => {
      localStorage.removeItem("ci360_identity");
      localStorage.removeItem("ci360_email");
      window.ci360_identity = "";
      $("identityInput").value = "";
      $("emailInput").value = "";
      log("Dados limpos.");
      alert("Dados de identity e email removidos. Atualize a página.");
    });

    // Testar runtime manualmente
    $("btnTestSdk").addEventListener("click", async () => {
      try {
        await aguardarRuntime(8000);
        setStatus("SDK detectado ✅ (runtime ativo)", "ok");
        log("Teste de runtime: OK");
        alert("Runtime do CI360 carregado.");
      } catch {
        setStatus("Runtime não carregou ❌", "warn");
        log("Teste de runtime: falhou.");
        alert("Runtime não carregou. Verifique tenantId ou bloqueios (consent/adblock)");
      }
    });
  </script>
</body>
</html>
